<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pivot.aham.api.service.mapper.UserRechargeStatusMapper">

    <resultMap id="userRechargeStatusMap" type="com.pivot.aham.api.service.mapper.model.UserRechargeStatus">
        <id column="id" property="id"/>
        <result column="client_id" property="clientId"/>
        <result column="goal_id" property="goalId"/>
        <result column="currency" property="currency"/>
        <result column="amount" property="amount"/>
        <result column="status" property="userRechargeStatusEnum"/>
        <result column="bank_virtual_acc_order_id" property="bankVirtualAccOrderId"/>
        <result column="saxo_acc_order_id" property="saxoAccOrderId"/>
        <result column="acc_recharge_id" property="accRechargeId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>
    
    <sql id="base_column">
        id, client_id, goal_id, currency, amount, status, 
        bank_virtual_acc_order_id, saxo_acc_order_id, acc_recharge_id, create_time, update_time
    </sql>

    <insert id="saveUserRechargeStatus" useGeneratedKeys="true" keyProperty="id">
            INSERT INTO t_user_recharge_status (
            <trim suffixOverrides=",">
                <if test="@Ognl@isNotEmpty(id)">
                    id,
                </if>
                <if test="@Ognl@isNotEmpty(clientId)">
                    client_id,
                </if>
                <if test="@Ognl@isNotEmpty(goalId)">
                    goal_id,
                </if>
                <if test="@Ognl@isNotEmpty(currency)">
                    currency,
                </if>
                <if test="@Ognl@isNotEmpty(amount)">
                    amount,
                </if>
                <if test="@Ognl@isNotEmpty(userRechargeStatusEnum)">
                    status,
                </if>
                <if test="@Ognl@isNotEmpty(bankVirtualAccOrderId)">
                    bank_virtual_acc_order_id,
                </if>
                <if test="@Ognl@isNotEmpty(saxoAccOrderId)">
                    saxo_acc_order_id,
                </if>
                <if test="@Ognl@isNotEmpty(accRechargeId)">
                    acc_recharge_id,
                </if>
                <if test="@Ognl@isNotEmpty(createTime)">
                    create_time,
                </if>
                <if test="@Ognl@isNotEmpty(updateTime)">
                    update_time,
                </if>
            </trim>
            ) VALUES (
            <trim suffixOverrides=",">
                <if test="@Ognl@isNotEmpty(id)">
                    #{id},
                </if>
                <if test="@Ognl@isNotEmpty(clientId)">
                    #{clientId},
                </if>
                <if test="@Ognl@isNotEmpty(goalId)">
                    #{goalId},
                </if>
                <if test="@Ognl@isNotEmpty(currency)">
                    #{currency},
                </if>
                <if test="@Ognl@isNotEmpty(amount)">
                    #{amount},
                </if>
                <if test="@Ognl@isNotEmpty(userRechargeStatusEnum)">
                    #{userRechargeStatusEnum},
                </if>
                <if test="@Ognl@isNotEmpty(bankVirtualAccOrderId)">
                    #{bankVirtualAccOrderId},
                </if>
                <if test="@Ognl@isNotEmpty(saxoAccOrderId)">
                    #{saxoAccOrderId},
                </if>
                <if test="@Ognl@isNotEmpty(accRechargeId)">
                    #{accRechargeId},
                </if>
                <if test="@Ognl@isNotEmpty(createTime)">
                    #{createTime},
                </if>
                <if test="@Ognl@isNotEmpty(updateTime)">
                    #{updateTime},
                </if>
            </trim>
            )
        </insert>
        
        <update id="updateUserRechargeStatus">
        UPDATE t_user_recharge_status
        <set>
            <if test="@Ognl@isNotEmpty(userRechargeStatusEnum)">
                status=#{userRechargeStatusEnum},
            </if>
            <if test="@Ognl@isNotEmpty(saxoAccOrderId)">
                 saxo_acc_order_id=#{saxoAccOrderId},
            </if>
        </set>
        <where>
                 bank_virtual_acc_order_id = #{bankVirtualAccOrderId}
        </where>
        </update>
        
        <update id="updateUserRechargeStatusBySaxoOrderAccId">
        UPDATE t_user_recharge_status
        <set>
            <if test="@Ognl@isNotEmpty(userRechargeStatusEnum)">
                status=#{userRechargeStatusEnum},
            </if>
            <if test="@Ognl@isNotEmpty(accRechargeId)">
                acc_recharge_id=#{accRechargeId},
            </if>
        </set>
        <where>
                saxo_acc_order_id = #{saxoAccOrderId}
        </where>
        </update>
        
        <update id="updateUserRechargeStatusToSuccess">
        UPDATE t_user_recharge_status
        <set>
            <if test="@Ognl@isNotEmpty(userRechargeStatusEnum)">
                status=#{userRechargeStatusEnum},
            </if>
        </set>
        <where>
                acc_recharge_id = #{accRechargeId}
        </where>
        </update>
        
        <select id="getPendingDeposit" resultType="BigDecimal">
            SELECT IFNULL(SUM(amount) , 0)
            FROM t_user_recharge_status
        <where>
            <if test="@Ognl@isNotEmpty(clientId)">
                and client_id=#{clientId}
            </if>
            <if test="@Ognl@isNotEmpty(goalId)">
                and goal_id=#{goalId}
            </if>
            <if test="@Ognl@isNotEmpty(userRechargeStatusEnum)">
                
                <![CDATA[and status <> #{userRechargeStatusEnum} ]]>
            </if>
        </where>
    </select>
</mapper>
